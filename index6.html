<!DOCTYPE html>
<html>
<head>
  <title></title>
  <link href="css/timeline.css" rel="stylesheet" type="text/css" />
  <script src="bower_components/d3/d3.js"></script>
  <script src="bower_components/vis/dist/vis.js"></script>
  <script src="fakedata.js"></script>
</head>
<body>
<div id="rayChart"></div>
<div id="timeline"></div>
<script>
  (function() {
    d3.rayChart = function(options) {
      var cfg = {
       radius: 1,
       w: 400,
       h: 400,
       // factor: 1,
       // factorLegend: .85,
       // levels: 3,
       maxValue: 0,
       radians: 2 * Math.PI,
       // opacityArea: 0.5,
       // ToRight: 5,
       // TranslateX: 80,
       // TranslateY: 30,
       // ExtraWidthX: 300,
       // ExtraWidthY: 100,
       color: d3.scale.category10()
      };
      
      //var d = generateData(templateData, 3);

      function draw(g) {
        var data = g.datum();
        var allAxis = data[0].map(function(i, j){return i.axis});
        var total = allAxis.length;
        var radius = Math.min(cfg.w / 2, cfg.h / 2);
        //var Format = d3.format('%');
        // d3.select(id).select("svg").remove();

        var axis = g.selectAll(".axis")
            .data(allAxis)
            .enter()
            .append("g")
            .attr("class", "axis");

        axis.append("line")
          .attr("x1", cfg.w/2)
          .attr("y1", cfg.h/2)
          .attr("x2", function(d, i) { 
            return radius * (1 - Math.sin(i * cfg.radians / total));
          })
          .attr("y2", function(d, i) {
            return radius * (1 - Math.cos(i * cfg.radians / total));
          })
          .attr("class", "line")
          .style("stroke", "grey")
          .style("stroke-width", ".1px");

        axis.append("text")
          .attr("class", "legend")
          .text(function(d) {return d;})
          .style("font-family", "sans-serif")
          .style("font-size", "11px")
          .attr("text-anchor", "middle")
          .attr("dy", "1.5em")
          .attr("transform", function(d, i){return "translate(0, -10)"})
          .attr("x", function(d, i) {return radius * (1 - Math.sin(i * cfg.radians / total)) - 40 * Math.sin(i * cfg.radians / total);})
          .attr("y", function(d, i) {return radius * (1 - Math.cos(i * cfg.radians / total)) - 20 * Math.cos(i * cfg.radians / total);});

        cfg.maxValue = Math.max(cfg.maxValue, d3.max(data, function(i){
          return d3.max(i.map(function(o){
            return o.value;
          })) || 0
        }));

        var scale = d3.scale.linear()
          .domain([0, cfg.maxValue])
          .range([0, radius]);

        var lineSelection = g.selectAll('.res')
          .data(prepareData(data), function(d) {return d.$$groupIndex + d.axis;});

        lineSelection
          .enter()
          .append('g')
          .attr('class', 'res')
          .attr("data-id", function(d) { return d.axis})
            .append("line")
            .attr("x1", cfg.w/2)
            .attr("y1", cfg.h/2)
            .attr("x2", cfg.w/2)
            .attr("y2", cfg.h/2)
            .attr("class", "line")
            .style("stroke", function(d) {return cfg.color(d.$$groupIndex);})
            .style("stroke-width", function(d) {return (d.$$groupIndex + 1) * 2 + 'px';});

        lineSelection
          .select('line')
            .transition()
              .attr("x2", function(d, i) {
                return cfg.w / 2 + scale(d.value) * Math.sin(i * cfg.radians / total);
              })
              .attr("y2", function(d, i) {
                return cfg.h / 2 + scale(d.value) * Math.cos(i * cfg.radians / total);
              });

        lineSelection.exit().remove();
      };

      function prepareData(data) {
        return d3.merge(data.map(function(group, groupIndex) {
          return group.map(function(item, index) {
            return {
              axis: item.axis,
              value: item.value,
              $$groupIndex: groupIndex
            };
          });
        }));
      };

      return draw;
    };
  }());

  var rayChart = d3.rayChart();
  var cfg = {w: 400, h: 400, TranslateX: 80, TranslateY: 30}; //TODO: remove
  var g = d3.select('#rayChart')
    .append("svg")
    .attr("width", cfg.w + 300)
    .attr("height", cfg.h + 100)
    .append("g")
    .attr("transform", "translate(" + cfg.TranslateX + "," + cfg.TranslateY + ")");

  function generateData(templateData, groupCount) {
    var data = [];
    for (var i = 0; i < groupCount; i++) {
      data.push(templateData.map(function(item) {
        return {
          axis: item.axis,
          value: Math.random()
        };
      }));
    }

    return data;
  };

  function renderRayChart(data) {
    g.data(data).call(rayChart);
  }

  var items = new vis.DataSet([
    {id: 0, content: 'event 0', start: '2014-07-10'},
    {id: 1, content: 'event 1', start: '2014-07-20'},
    {id: 2, content: 'event 2', start: '2014-07-14'},
    {id: 3, content: 'event 3', start: '2014-07-18'},
    {id: 4, content: 'event 4', start: '2014-07-16'},
    {id: 5, content: 'event 5', start: '2014-07-25'},
    {id: 6, content: 'event 6', start: '2014-07-27'}
  ]);

  var container = document.getElementById('timeline');
  var options = {
    // editable: true
  };
  var timeline = new vis.Timeline(container, items, options);

  // timeline.on('rangechange', function (properties) {
  //   logEvent('rangechange', properties);
  // });
  // timeline.on('rangechanged', function (properties) {
  //   logEvent('rangechanged', properties);
  // });
  timeline.on('select', function (properties) {
    //logEvent('select', properties);
    if (properties.items.length) {
      renderRayChart([generateData(templateData, 3)]);
    } else {
      renderRayChart([[]]);
    }
  });

  // render(generateData(templateData, 2));
  // window.setInterval(function() {
  //   render(generateData(templateData, 6));
  // }, 3000);

  // d.forEach(function(y, x){
  //   g.selectAll(".nodes")
  //   .data(y).enter()
  //   .append("svg:circle")
  //   .attr("class", "radar-chart-serie"+series)
  //   .attr('r', cfg.radius)
  //   .attr("alt", function(j){return Math.max(j.value, 0)})
  //   .attr("cx", function(j, i){
  //     dataValues.push([
  //       cfg.w/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.sin(i*cfg.radians/total)), 
  //       cfg.h/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.cos(i*cfg.radians/total))
  //     ]);
  //     return cfg.w/2*(1-(Math.max(j.value, 0)/cfg.maxValue)*cfg.factor*Math.sin(i*cfg.radians/total));
  //   })
  //   .attr("cy", function(j, i){
  //     return cfg.h/2*(1-(Math.max(j.value, 0)/cfg.maxValue)*cfg.factor*Math.cos(i*cfg.radians/total));
  //   })
  //   .attr("data-id", function(j){return j.axis})
  //   .style("fill", cfg.color(series)).style("fill-opacity", .9)
  //   .on('mouseover', function (d){
  //         newX =  parseFloat(d3.select(this).attr('cx')) - 10;
  //         newY =  parseFloat(d3.select(this).attr('cy')) - 5;
          
  //         tooltip
  //           .attr('x', newX)
  //           .attr('y', newY)
  //           .text(Format(d.value))
  //           .transition(200)
  //           .style('opacity', 1);
            
  //         z = "polygon."+d3.select(this).attr("class");
  //         g.selectAll("polygon")
  //           .transition(200)
  //           .style("fill-opacity", 0.1); 
  //         g.selectAll(z)
  //           .transition(200)
  //           .style("fill-opacity", .7);
  //         })
  //   .on('mouseout', function(){
  //         tooltip
  //           .transition(200)
  //           .style('opacity', 0);
  //         g.selectAll("polygon")
  //           .transition(200)
  //           .style("fill-opacity", cfg.opacityArea);
  //         })
  //   .append("svg:title")
  //   .text(function(j){return Math.max(j.value, 0)});

  //   series++;
  // });

  // axis.append("text")
  //   .attr("class", "legend")
  //   .text(function(d){return d})
  //   .style("font-family", "sans-serif")
  //   .style("font-size", "11px")
  //   .attr("text-anchor", "middle")
  //   .attr("dy", "1.5em")
  //   .attr("transform", function(d, i){return "translate(0, -10)"})
  //   .attr("x", function(d, i){return cfg.w/2*(1-cfg.factorLegend*Math.sin(i*cfg.radians/total))-60*Math.sin(i*cfg.radians/total);})
  //   .attr("y", function(d, i){return cfg.h/2*(1-Math.cos(i*cfg.radians/total))-20*Math.cos(i*cfg.radians/total);});

 
  // d.forEach(function(y, x){
  //   dataValues = [];
  //   g.selectAll(".nodes")
  //   .data(y, function(j, i){
  //     dataValues.push([
  //     cfg.w/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.sin(i*cfg.radians/total)), 
  //     cfg.h/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.cos(i*cfg.radians/total))
  //     ]);
  //   });
  //   dataValues.push(dataValues[0]);
  //   g.selectAll(".area")
  //          .data([dataValues])
  //          .enter()
  //          .append("polygon")
  //          .attr("class", "radar-chart-serie"+series)
  //          .style("stroke-width", "2px")
  //          .style("stroke", cfg.color(series))
  //          .attr("points",function(d) {
  //            var str="";
  //            for(var pti=0;pti<d.length;pti++){
  //              str=str+d[pti][0]+","+d[pti][1]+" ";
  //            }
  //            return str;
  //           })
  //          .style("fill", function(j, i){return cfg.color(series)})
  //          .style("fill-opacity", cfg.opacityArea)
  //          .on('mouseover', function (d){
  //                   z = "polygon."+d3.select(this).attr("class");
  //                   g.selectAll("polygon")
  //                    .transition(200)
  //                    .style("fill-opacity", 0.1); 
  //                   g.selectAll(z)
  //                    .transition(200)
  //                    .style("fill-opacity", .7);
  //                   })
  //          .on('mouseout', function(){
  //                   g.selectAll("polygon")
  //                    .transition(200)
  //                    .style("fill-opacity", cfg.opacityArea);
  //          });
  //   series++;
  // });
  // series=0;


  // d.forEach(function(y, x){
  //   g.selectAll(".nodes")
  //   .data(y).enter()
  //   .append("svg:circle")
  //   .attr("class", "radar-chart-serie"+series)
  //   .attr('r', cfg.radius)
  //   .attr("alt", function(j){return Math.max(j.value, 0)})
  //   .attr("cx", function(j, i){
  //     dataValues.push([
  //     cfg.w/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.sin(i*cfg.radians/total)), 
  //     cfg.h/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.cos(i*cfg.radians/total))
  //   ]);
  //   return cfg.w/2*(1-(Math.max(j.value, 0)/cfg.maxValue)*cfg.factor*Math.sin(i*cfg.radians/total));
  //   })
  //   .attr("cy", function(j, i){
  //     return cfg.h/2*(1-(Math.max(j.value, 0)/cfg.maxValue)*cfg.factor*Math.cos(i*cfg.radians/total));
  //   })
  //   .attr("data-id", function(j){return j.axis})
  //   .style("fill", cfg.color(series)).style("fill-opacity", .9)
  //   .on('mouseover', function (d){
  //         newX =  parseFloat(d3.select(this).attr('cx')) - 10;
  //         newY =  parseFloat(d3.select(this).attr('cy')) - 5;
          
  //         tooltip
  //           .attr('x', newX)
  //           .attr('y', newY)
  //           .text(Format(d.value))
  //           .transition(200)
  //           .style('opacity', 1);
            
  //         z = "polygon."+d3.select(this).attr("class");
  //         g.selectAll("polygon")
  //           .transition(200)
  //           .style("fill-opacity", 0.1); 
  //         g.selectAll(z)
  //           .transition(200)
  //           .style("fill-opacity", .7);
  //         })
  //   .on('mouseout', function(){
  //         tooltip
  //           .transition(200)
  //           .style('opacity', 0);
  //         g.selectAll("polygon")
  //           .transition(200)
  //           .style("fill-opacity", cfg.opacityArea);
  //         })
  //   .append("svg:title")
  //   .text(function(j){return Math.max(j.value, 0)});

  //   series++;
  // });
</script>
</body>
</html>